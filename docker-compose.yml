# ============================================================================
# DOCKER COMPOSE - Hello Mira Flight Platform
# ============================================================================
#
# Orchestration complete du systeme :
# - MongoDB (base de donnees + cache)
# - Airport microservice (API REST)
# - Flight microservice (API REST)
# - Assistant microservice (IA conversationnelle)
#
# Usage :
#   docker-compose up -d              # Demarre en background
#   docker-compose logs -f airport    # Logs en temps reel
#   docker-compose logs -f flight     # Logs Flight
#   docker-compose logs -f assistant  # Logs Assistant
#   docker-compose down               # Arrete tout
#   docker-compose down -v            # Arrete + supprime volumes
#
# Prerequis :
#   - Fichier .env a la racine avec :
#     AVIATIONSTACK_API_KEY=xxx
#     MISTRAL_API_KEY=xxx
#     MONGO_PASSWORD=xxx
#
# ============================================================================

# ============================================================================
# SERVICES
# ============================================================================

services:
  # ==========================================================================
  # MongoDB - Base de donnees et cache
  # ==========================================================================
  mongo:
    image: mongo:7.0
    container_name: hello-mira-mongo
    restart: unless-stopped

    # Variables d'environnement
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: hello_mira

    # Ports exposes (optionnel pour debug)
    ports:
      - "27017:27017"

    # Volume persistant pour les donnees
    volumes:
      - mongo_data:/data/db
      - mongo_config:/data/configdb

    # Health check
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/hello_mira --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

    # Reseau dedie
    networks:
      - hello-mira-network

    # Logging limite
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # Gateway - API Gateway pour Aviationstack
  # ==========================================================================
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile

    image: hello-mira/gateway:latest
    container_name: hello-mira-gateway
    restart: unless-stopped

    # Dependances
    depends_on:
      mongo:
        condition: service_healthy

    # Variables d'environnement
    environment:
      # API Aviationstack
      AVIATIONSTACK_API_KEY: ${AVIATIONSTACK_API_KEY}

      # MongoDB (avec authentification)
      MONGODB_URL: mongodb://admin:${MONGO_PASSWORD}@mongo:27017
      MONGODB_DATABASE: hello_mira

      # Cache
      CACHE_TTL: 300

      # Application
      DEBUG: ${DEBUG:-false}

    # Ports exposes
    ports:
      - "8004:8004"

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; exit(0 if httpx.get('http://localhost:8004/health').status_code == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Reseau dedie
    networks:
      - hello-mira-network

    # Logging limite
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # Airport - Microservice de recherche d'aeroports
  # ==========================================================================
  airport:
    build:
      context: ./airport
      dockerfile: Dockerfile

    image: hello-mira/airport:latest
    container_name: hello-mira-airport
    restart: unless-stopped

    # Dependances (Gateway pour les appels API)
    depends_on:
      gateway:
        condition: service_healthy

    # Variables d'environnement
    environment:
      # Gateway (centralise les appels Aviationstack)
      GATEWAY_URL: http://gateway:8004

      # Application
      DEBUG: ${DEBUG:-false}

      # CORS (pour le frontend)
      CORS_ORIGINS: '["http://localhost:3000", "http://localhost:8000", "http://localhost:8501"]'

    # Ports exposes
    ports:
      - "8001:8001"

    # Health check (herite du Dockerfile + override)
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; exit(0 if httpx.get('http://localhost:8001/api/v1/health').status_code == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Reseau dedie
    networks:
      - hello-mira-network

    # Logging limite
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # Flight - Microservice de suivi de vols individuels
  # ==========================================================================
  flight:
    build:
      context: ./flight
      dockerfile: Dockerfile

    image: hello-mira/flight:latest
    container_name: hello-mira-flight
    restart: unless-stopped

    # Dependances (Gateway + MongoDB pour l'historique)
    depends_on:
      gateway:
        condition: service_healthy
      mongo:
        condition: service_healthy

    # Variables d'environnement
    environment:
      # Gateway (centralise les appels Aviationstack)
      GATEWAY_URL: http://gateway:8004

      # MongoDB (pour l'historique des vols uniquement)
      MONGODB_URL: mongodb://admin:${MONGO_PASSWORD}@mongo:27017
      MONGODB_DATABASE: hello_mira
      MONGODB_TIMEOUT: 5000

      # Application
      DEBUG: ${DEBUG:-false}

      # CORS (pour le frontend)
      CORS_ORIGINS: '["http://localhost:3000", "http://localhost:8000", "http://localhost:8501"]'

    # Ports exposes
    ports:
      - "8002:8002"

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; exit(0 if httpx.get('http://localhost:8002/api/v1/health').status_code == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Reseau dedie
    networks:
      - hello-mira-network

    # Logging limite
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # Assistant - Microservice d'IA conversationnelle
  # ==========================================================================
  assistant:
    build:
      context: ./assistant
      dockerfile: Dockerfile

    image: hello-mira/assistant:latest
    container_name: hello-mira-assistant
    restart: unless-stopped

    # Dependances (attend que Airport et Flight soient healthy)
    depends_on:
      airport:
        condition: service_healthy
      flight:
        condition: service_healthy

    # Variables d'environnement
    environment:
      # API Mistral AI
      MISTRAL_API_KEY: ${MISTRAL_API_KEY}
      MISTRAL_MODEL: ${MISTRAL_MODEL:-open-mixtral-8x7b}
      MISTRAL_TEMPERATURE: 0.0

      # URLs des microservices
      AIRPORT_API_URL: http://airport:8001/api/v1
      FLIGHT_API_URL: http://flight:8002/api/v1
      HTTP_TIMEOUT: 30

      # Application
      DEBUG: ${DEBUG:-false}
      DEMO_MODE: ${DEMO_MODE:-false}  # Mode démo avec données mockées (pas de quota API Aviationstack)
      MAX_TOKENS: 1000
      ENABLE_STREAMING: "false"

      # CORS (pour le frontend)
      CORS_ORIGINS: '["http://localhost:3000", "http://localhost:8000", "http://localhost:8501"]'

    # Ports exposes
    ports:
      - "8003:8003"

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; exit(0 if httpx.get('http://localhost:8003/api/v1/health').status_code == 200 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Reseau dedie
    networks:
      - hello-mira-network

    # Logging limite
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # Prometheus - Collecte de métriques
  # ==========================================================================
  prometheus:
    image: prom/prometheus:v2.54.0
    container_name: hello-mira-prometheus
    restart: unless-stopped

    # Dépendances (attend que les services soient lancés)
    depends_on:
      - airport
      - flight
      - assistant

    # Configuration Prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus

    # Arguments de lancement
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=15d'

    # Ports exposés
    ports:
      - "9090:9090"

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Réseau dédié
    networks:
      - hello-mira-network

    # Logging limité
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # Grafana - Visualisation des métriques
  # ==========================================================================
  grafana:
    image: grafana/grafana:10.2.2
    container_name: hello-mira-grafana
    restart: unless-stopped

    # Dépendances
    depends_on:
      prometheus:
        condition: service_healthy

    # Configuration Grafana
    environment:
      # Admin credentials
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}

      # Anonymous access (utile pour démo)
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer

      # Server settings
      GF_SERVER_ROOT_URL: http://localhost:3000
      GF_SERVER_SERVE_FROM_SUB_PATH: "false"

      # Datasources
      GF_DATASOURCES_DEFAULT_NAME: Prometheus

    # Volumes pour persistance et provisioning
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro

    # Ports exposés
    ports:
      - "3000:3000"

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Réseau dédié
    networks:
      - hello-mira-network

    # Logging limité
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # Frontend - Interface Streamlit avec authentification Supabase
  # ==========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile

    image: hello-mira/frontend:latest
    container_name: hello-mira-frontend
    restart: unless-stopped

    # Dépendances
    depends_on:
      assistant:
        condition: service_healthy

    # Variables d'environnement
    environment:
      # URLs des microservices (internes au réseau Docker)
      ASSISTANT_URL: http://assistant:8003
      AIRPORT_URL: http://airport:8001
      FLIGHT_URL: http://flight:8002

    # Secrets Supabase (à configurer dans .streamlit/secrets.toml)
    volumes:
      - ./frontend/.streamlit:/app/.streamlit:ro

    # Ports exposés
    ports:
      - "8501:8501"

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Réseau dédié
    networks:
      - hello-mira-network

    # Logging limité
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ============================================================================
# NETWORKS
# ============================================================================

networks:
  hello-mira-network:
    name: hello-mira-network
    driver: bridge

# ============================================================================
# VOLUMES
# ============================================================================

volumes:
  mongo_data:
    name: hello-mira-mongo-data
  mongo_config:
    name: hello-mira-mongo-config
  prometheus_data:
    name: hello-mira-prometheus-data
  grafana_data:
    name: hello-mira-grafana-data

# ============================================================================
# NOTES TECHNIQUES
# ============================================================================
#
# Architecture :
# - Reseau bridge dedie (hello-mira-network)
# - Volume nomme pour persistance MongoDB
# - Health checks sur tous les services
# - Restart policy : unless-stopped (redemarre sauf si arret manuel)
# - Logging rotatif (10MB max, 3 fichiers)
#
# Securite :
# - MongoDB avec authentification admin
# - Secrets via .env (pas de hardcoding)
# - Container airport tourne en user non-root (UID 1000)
#
# Performance :
# - MongoDB 7.0 (derniere version stable)
# - Healthcheck intelligent avec start_period pour eviter false negatives
# - Cache TTL configurable (300s par defaut)
#
# Microservices :
# - Airport (port 8001) : Recherche d'aeroports et vols au depart/arrivee
# - Flight (port 8002) : Suivi de vols individuels et statistiques
# - Assistant (port 8003) : IA conversationnelle (LangGraph + Mistral AI)
#
# Evolutivite :
# - Pret pour ajout frontend React
# - Pret pour extension multi-langue
#
# Commandes utiles :
#   docker-compose up --build        # Rebuild + start
#   docker-compose ps                # Etat des services
#   docker-compose exec mongo mongosh # Shell MongoDB
#   docker-compose exec airport sh   # Shell dans container airport
#   docker-compose exec flight sh    # Shell dans container flight
#   docker-compose exec assistant sh # Shell dans container assistant
#   docker-compose logs -f airport   # Logs Airport en temps reel
#   docker-compose logs -f flight    # Logs Flight en temps reel
#   docker-compose logs -f assistant # Logs Assistant en temps reel
#   docker-compose logs --tail=100   # 100 dernieres lignes de logs
#
# ============================================================================
